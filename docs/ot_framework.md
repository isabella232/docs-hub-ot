# Operational Tools Framework
<br/>

## General overview. Internal perspective
<div align="justify">

Similar as WSDL describe web services, in PIXEL we define a structure to handle models and Predictive algorithms (PAs). The structure is divided into various blocks, though we will mainly handle the *GeneralInfo* and *DockerInfo* structures for publication purposes (associated with *getInfo.json*).
<p align="center">
<img src="https://github.com/pixel-ports/docs-hub-ot/raw/master/docs/img/ot_framework_general_overview.jpg" alt="OT_framework_general_overview" align="center" />
</p>

</div>
<br/>



## Specification of a model (getInfo.json)
<br/>

### Introduction
<div align="justify">

A model (referring to both PIXEL models and PIXEL predictive algorithms) can be specified by a set of parameters related to:

- **name, version, description, category**: name, version, description and category of the model.

- **type**: type of model (model or pa). The term 'pa' stands for predictive algorithm

- **invocation model**: describes how the model is invoked (synchronous execution, asynchronous execution and subscription model).

- **inputs**: describes the different inputs (mandatory or optional) needed by the model to be executed

- **outputs**: describes the different outputs generated by the model after its execution

- **logging**: describes the logging capabilities of the model

The previous fields are specified in a **JSON format** that will be described in the next chapter.
This format is included as a Docker LABEL by the time the Dockerfile of a (PIXEL) model is created, so that once the image is uploaded into the Docker repository (e.g. Dockerhub), it contains all information. A normal user or a software component can perform a *docker inspect* to get the description of the model.
With this information, the user or a software component can generate another JSON (known as instance JSON) with specific information to execute the model (e.g. some input parameters within a given timeframe).

</div>
<br/>

### Publication of a model in the PIXEL platform. General flow
<div align="justify">

There are several steps to be performed if you want publish a model in the PIXEL platform, as depicted in the Figure below.
<p align="center">
<img src="https://github.com/pixel-ports/docs-hub-ot/raw/master/docs/img/ot_framework_pubModel_overview.jpg" alt="publication of a model (Steps)" align="center" />
</p>

- **Step 1**: publish the model providing essential information, basically the one related to *DockerInfo* (see the *OT Framework overview*). Here the operation is performed by the Dashboard, but for testing purposes one can also use the OT API (in fact the Dashboard uses it)

- **Step 2**: Get the Docker image from the public repository (*docker pull*). In PIXEL we are using Dockerhub under the index pixelh2020

- **Step 3**: Inspect the Docker to get the description of the information (*docker inspect*). This is stored under the label *getInfo*.

- **Step 4**: Now the Dashboard can request the OT to get information from available models, e.g. before building an instance for executing the model.

For the *step 3*, it is supposed that the model developer has included a JSON structure as *label* in the *Dockerfile*, that will be commented in the next chapter. As it is included as label, it is important minimize it, thus the model developer can use an online service (e.g. via **https://jsonformatter.org/json-minify**) to make the conversion from a standard JSON file.

</div>
<br/>

### JSON format
<div align="justify">

In order to better understand the JSON format (instead of providing the schema), we will use as example the basic **pingcount** model, available at *https://gitpixel.satrdlab.upv.es/benmomo/ngsi-agents-thpa/src/master/thpa-model-pingcount*. The model is able to count the number of pings of a given set of elements of type Ping. This is a PIXEL data model generated by a basic PingTest NGSI agent (Available at *https://gitpixel.satrdlab.upv.es/benmomo/ngsi-agents-thpa/src/master/thpa-ping*)

The JSON format is as follows:


```
{
   "name":"pingcount",
   "version":"0.1",
   "description":"PingCount model. It checks for incoming pings from an NGSI Ping Agent and counts them within a timeframe. It serves as documentation example",
   "type":"model",
   "category":"ping",
   "supportSubscription":false,
   "supportExecSync":false,
   "supportExecAsync":true,
   "system":{
      "connectors":[
         {
            "type":"ih-api",
            "description": "Needed connection data to reach the Information Hub API in the PIXEL platform. This API is typically used by models/PA to get data",
            "options":[
               {
                  "name":"url",
                  "type":"string",
                  "pattern":null,
                  "description":"URL string representing the API to reach the IH. If a value is given in getInfo.json, it represents a default value",
                  "required": true,
                  "value": "http://172.24.1.17:8080/archivingSystem/extractor/v1"
               },
               {
                  "name":"user",
                  "type":"string",
                  "pattern": null,
                  "description":"Credentials (user) if IH requires authentication. Currently not needed (future use)",
                  "required": false,
                  "value":null
               },
               {
                  "name":"password",
                  "type":"string",
                  "pattern": null,
                  "description":"Credentials (password) if IH requires authentication. Currently not needed (future use)",
                  "required": false,
                  "value":null
               }
            ]
         },
         {
            "type":"es-api",
            "description": "Needed connection data to reach the Elasticsearch API in the PIXEL platform.This API is typically used by models/PA to store (result) data",
            "options":[
               {
                  "name":"url",
                  "type":"string",
                  "pattern": null,
                  "description":"URL string representing the API to reach Elasticsearch. If a value is given in getInfo.json, it represents a default value",
                  "required": true,
                  "value": "http://172.24.1.11:9200"
               },
               {
                  "name":"user",
                  "type":"string",
                  "pattern": null,
                  "description":"credentials (user) if Elastic requires authentication. Currently not needed (future use)",
                  "required": false,
                  "value":null
               },
               {
                  "name":"password",
                  "type":"string",
                  "pattern": null,
                  "description":"credentials (password) if Elastic requires authentication. Currently not needed (future use)",
                  "required": false,
                  "value":null
               }
            ]
         }

      ]
   },
   "input":[
      {
         "name":"pingset",
         "type":"[urn:pixel:DataSource:Ping]",
         "description":"array of JSON documents of type urn:pixel:DataSource:Ping. Additional info to retrieve the data is given in 'options' array",
         "supportedConnectors": ["ih_api"],
         "metadata":{},
         "required":true,
         "forceinput": true,
         "options":[
            {
               "name":"sourceId",
               "type":"string",
               "value": "ping",
               "description":"sourceId (mapped to Index) within the IH where the NGSI generated pings are stored. If a value is given in getInfo.json, it represents a default value",
               "pattern":null,
               "metadata":{},               
               "required": true
            },
            {
               "name":"from",
               "type":"date-time",
               "value": "last-hour",
               "description":". From timestamp. ISO8601 format. If a value is given in getInfo.json, it represents a default value",
               "pattern":null,
               "metadata":{},               
               "required": true
            },
            {
               "name":"to",
               "type":"date-time",
               "value": "now",
               "description":". To timestamp. ISO8601 format. If a value is given in getInfo.json, it represents a default value",
               "pattern":null,
               "metadata":{},               
               "required": true
            }
         ]
      }    

   ],   
   "output":[
      {
         "name":"output",
         "type":"urn:pixel:DataModelResult:PingCount",         
         "required":true,
         "description":"output provided by the PingCount execution",
         "supportedConnectors": ["es-api"],
         "metadata:":{},
         "options":[
            {
               "name": "es_index",
               "type": "string",
               "description": " Elasticsearch index to store the result  of the execution. Typically models will store output under index models-output-<name>",
               "pattern": null,
               "required": false,
               "value": "models-output-pingcount"
            }            
         ]
      }
   ],
   "logging": [
        {
            "name": "ping-logging",
            "type": "pixel-logging-format",
            "supportedConnectors": ["es-api"],
            "description": "activity logging for the pingCount model. id (id_execution, idRef (id_model) are given by the OT at invocation time",
            "required": true,
            "verbose": null,
            "metadata": {},
            "options":[
	            {
	               "name": "es_index",
	               "type": "string",
	               "description": " Elasticsearch index to store the logs of the execution (start, end, error). All models will store output under same index",
	               "pattern": null,
	               "required": false,
	               "value": "models-logging"
	            }            
	        ]            
        }
   ]
}
```

We will go element by element to clarify them:

   - **name (mandatory)**: this is the name of your model (string).

   - **version (mandatory)**: this is the version of your model (string).

   - **description (optional)**: this is the description of your model (string).

   - **type (mandatory)**: this is the type of your model string). Two possible values: *model* or *pa*, the latter one for predictive algorithms. It is just a convention as PIXEL differentiates between models and predictive algorithms.

   - **category (mandatory)**: this is the category of your model (string). No specific list of categories have been described in PIXEL, but some have been pre-identified according to the models developed in PIXEL, such as *environmental, traffic, pas*, etc.

   - **supportSubscription (mandatory)**: indicates whether your model supports subscription mode while execution (boolean). This is the case of some predictive algorithms developed in PIXEL.

   - **supportExecSync (mandatory)**: indicates whether your model supports synchronous mode while execution (boolean). This is not the case for the models developed in PIXEL, but it could be useful in the future.

  - **supportExecASync (mandatory)**: indicates whether your model supports asynchronous mode while execution (boolean). This is the typical case for the models developed in PIXEL. There is no waiting time at invocation and the outputs are stored in the IH as the models end executing.

  - **system (mandatory)**: this is an element intended to encompass general information of the model. Currently it includes one single element (array) called *connectors*, which will be described later.

  - **input (mandatory)**: this is an array intended to encompass all needed inputs. Such input array will be described later. In the example there is only one single input element, but another model might need more inputs.

  - **output (mandatory)**: this is an array intended to encompass all needed outputs. Such output array will be described later. Typically there will be only one output element, which can be mapped as a JSON document stored in a database (IH in PIXEL)

  - **logging (mandatory)**: this is an array intended to encompass all needed logging mechanisms. Such logging array will be described later. Typically there will be only one logging element, which generates all logging info as JSON documents to be stored in a database (IH in PIXEL)


Now let's deep into the different elements describing the details.

The **connectors** element defines the ability of a model to connect to different services (endpoints) to get data. It can be open data APIs, databases, etc. In PIXEL, there are basically two connectors that need to be supported natively: (i) the Information Hub  *ih-api* connector and (ii) the Elasticsearch *es-api* connector. A model will typically get information from the IH via the *ih-api* and store the data in the IG via de *es-pi*. The way they are defined follow a common format, as you can appreciate in the JSON example. The different fields are:

  - **type (mandatory)**: this is the supported type (string). Typically *ih-api* or *es-api*

  - **description (optional)**: this is the description of this element (string).

  - **options (mandatory)**: this is an array of elements containing the different items to access the service endpoint. The elements given in the example refer to the URL endpoint and credentials (if needed). Let's focus only on the first element, as the format is the same for the others:

      - **name (mandatory)**: name of the element.
      - **type (mandatory)**: type of the element. For URLs it is a string
      - **pattern (optional)**: Allows to specify if the string has to follow a specific pattern. It will allow to pre-check if the string is URL-compliant before launching a model. This field is only useful for the Dashboard.
      - **description (optional)**: description of the element.
      - **required (mandatory)**: indicates if this element is mandatory to build the connector (boolean). This means, in case it is not required, this element might not appear in the JSON instance. This field is useful for the Dashboard, so that it will block (or not) the user unless this element in given before letting him/her execute the model.
      - **value (optional)**: default value of the element. This field is useful to the Dashboard in order to simplify the insertion of data for the user before launching a model. For the PIXEL platform default endpoints for the *ih-api* and the *es-api* are given in the example.  


The **input** array includes all needed inputs needed by the model. The way they are defined follow a common format, as you can appreciate in the JSON example. The different fields are:

  - **name (mandatory)**: name of the input (string).

  - **type (mandatory)**: this is the data source (data format) of this input (string). PIXEL specifies a set of different data models trying to follow FIWARE. Formats are important because otherwise models will have to convert them.

  - **description (optional)**: this is the description of this element (string).

  - **supportedConnectors (mandatory)**: this is the connector that will use the model to get the input element (string). In PIXEL typically it will be the *ih-api* connector. This means that the input is located in the IH and the model will need to contact the IH API to obtain this particular piece of information.

  - **metadata (optional)**: optional element to include extra information specific for the model.

  - **required (mandatory)**: indicates if this input is mandatory to execute the model (boolean). This means, in case it is not required, this input might not appear in the JSON instance. This field is useful for the Dashboard, so that it will block (or not) the user unless this input in given before letting him/her execute the model.

  - **forceinput (mandatory)**: indicates if this input can be forced by the user to execute the model (boolean). This means, in case it is forced, that the input will appear in a different array in the JSON instance. An example will be given in the chapter of *Execution of a model (instance.json)*. The ability of forcing inputs is interesting for what-if scenarios, where the user may work with ficticious data to get results, without the need to have this data stored previously in the IH. This field is important for the Dashboard, so that it can allow the user generate the input (i) as an input element within the input array or (ii) as a forceinput element. For the model, when it starts execution and checks for inputs, the *forceinput* array will have priority. This will also be explained in the chapter of *Execution of a model (instance.json)*

  - **options (mandatory)**: this is an array of elements containing the different items to access the element by using the service endpoint. The elements given in the example refer to the *sourceId* and *lower* and *upper* temporal limits. This means that the model will obtain the input by using the *ih-api* connector (and thus its *options* array) and also the options array of the input element. With the *ih-api* connector the model only knows the API, but to reach specific data it needs to build the specific request based on the additional parameters. In the example, *sourceId* maps to an index of the database, and the temporal limits allow to get all data between that time interval.  Let's focus only on the format of the first element, as the format is the same for the others:

      - **name (mandatory)**: name of the element (string).
      - **type (mandatory)**: type of the element (string).
      - **value (optional)**: default value of the element. This field is useful to the Dashboard in order to simplify the insertion of data for the user before launching a model. For the PIXEL platform with inputs coming from NGSI agents, values are typicaly *arh-lts-<datamodel_id>*.  
      - **description (optional)**: description of the element.
      - **pattern (optional)**: Allows to specify if the string has to follow a specific pattern. This field is only useful for the Dashboard.
      - **metadata (optional)**: optional element to include extra information specific for the model.
      - **required (mandatory)**: indicates if this element is mandatory to build the input (boolean). This means, in case it is not required, this element might not appear in the JSON instance. This field is useful for the Dashboard, so that it will block (or not) the user unless this element in given before letting him/her execute the model.


The **output** array follows a similar format as the input array, as you can appreciate in the JSON example. The different fields are:

  - **name (mandatory)**: name of the output (string). Typically, if you are having just one element in the array, you can name it *output*

  - **type (mandatory)**: this is the data source (data format) of this output (string). FIWARE data models are more related to NGSI agents and inputs, for outputs there is no strong need to follow such model (Although possible).

  - **required (mandatory)**: indicates if this output is mandatory for the model (boolean). For one single element in the output array this will typically be *true*.

  - **description (optional)**: this is the description of this element (string).

  - **supportedConnectors (mandatory)**: this is the connector that will use the model to store the output element (string). In PIXEL typically it will be the *es-api* connector. This means that the output will be stored in the IH and the model will need to contact the Elasticsearch API to save this particular piece of information.

  - **metadata (optional)**: optional element to include extra information specific for the model.

  - **options (mandatory)**: this is an array of elements containing the different items to allow the model to store the output in a particular place so that it can be later be accessible to other components (e.g. visualization component)  Let's focus only on the format of the first (and only) element:

      - **name (mandatory)**: name of the element (string).
      - **type (mandatory)**: type of the element (string).
      - **description (optional)**: description of the element.
      - **pattern (optional)**: Allows to specify if the string has to follow a specific pattern. This field is only useful for the Dashboard.
      - **required (mandatory)**: indicates if this element is mandatory to build the output (boolean). For one single element it is *true*, unless the model does not need to store any output.
      - **value (optional)**: default value of the element. This field is useful to the Dashboard in order to simplify the insertion of data for the user before launching a model. For the PIXEL platform  values are typically *models-output-<model-name>*. Therefore, any component looking for results from this model can easily locate all results under this index.  


The **logging** array follows a similar format as the input and output array, as you can appreciate in the JSON example. The different fields are:

  - **name (mandatory)**: name of the logging (string). Typically, if you are having just one element in the array, you can name it *<model-name-logging*

  - **type (mandatory)**: this is the data source (data format) of this logging (string). In PIXEL we have already defined a specific format containing *iso_8601_timestamp, id_execution, id_model, type and message* . Models should log at least start and end time.

  - **supportedConnectors (mandatory)**: this is the connector that will use the model to store the logging element (string). In PIXEL typically it will be the *es-api* connector. This means that the logging will be stored in the IH and the model will need to contact the Elasticsearch API to save this particular piece of information.

  - **description (optional)**: this is the description of this element (string).

  - **required (mandatory)**: indicates if this logging is mandatory for the model (boolean). For one single element in the logging array this will typically be *true*.

  - **verbose (optional)**: verbosity level for the model (string). A model might provide different levels for logging (e.g. DEBUG, INFO, WARNING, ERROR, etc.)

  - **metadata (optional)**: optional element to include extra information specific for the model.

  - **options (mandatory)**: this is an array of elements containing the different items to allow the model to store the logging in a particular place so that it can be later be accessible to other components (e.g. visualization component)  Let's focus only on the format of the first (and only) element:

      - **name (mandatory)**: name of the element (string).
      - **type (mandatory)**: type of the element (string).
      - **description (optional)**: description of the element.
      - **pattern (optional)**: Allows to specify if the string has to follow a specific pattern. This field is only useful for the Dashboard.
      - **required (mandatory)**: indicates if this element is mandatory to build the output (boolean). For one single element it is *true*, unless the model does not need to store any logging.
      - **value (optional)**: default value of the element. This field is useful to the Dashboard in order to simplify the insertion of data for the user before launching a model. For the PIXEL platform  values are typically *models-logging>*. All models will then log data under the same index, but they can be filtered by *id_model, id_execution*, etc..  





## Execution of a model (instance.json)

### Introduction
<div align="justify">

TBD
</div>
<br/>

### JSON format
<div align="justify">

TBD

<br/>
</div>


## Scheduling executions of a model (scheduledInstance.json)
### Introduction
<div align="justify">

TBD
</div>
<br/>

### JSON format
<div align="justify">
TBD
</div>

#
